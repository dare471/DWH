WITH ALLDATE AS (SELECT *,FORMAT( CAST( [ALL].[ИИН/БИН.2] AS FLOAT),'000000000000') AS IIN_BIN_2 FROM [LX].[dbo].[000440005718 ЭСФ реализация за  2023_Лист2_new] as [ALL])

SELECT distinct [Статус ЭСФ]	  
,[Reg_No] [Регистрационный номер ЭСФ (14/02/2023)]
	  ,YEAR(CONVERT(DATE, [Дата совершения оборота], 101)) AS [Год]
	  ,MONTH(CONVERT(DATE, [Дата совершения оборота], 101)) AS [Месяц]
      ,CONVERT(DATE, [Дата совершения оборота], 101) AS [Дата совершения оборота]
	  ,SC.Категория
      ,'' AS [Культура]
	  ,SP.[Наименование товара]
      ,AD.[Наименование ТРУ]
	  ,AD.[Наименование товаров в соответствии с Декларацией на товары или заявления о ввозе товаров и уплате косвенных налогов]
      ,[Единица измерения] AS [Код ед. изм]
      ,ED.naimenovanie [ед. изм]
      ,CAST([Кол-во (объем)] AS FLOAT) AS [Кол-во]
      ,CAST([Цена (тариф) за единицу ТРУ без косвенных налогов]AS FLOAT) AS [Цена за ед, без НДС]
	  ,CAST([Стоимость товаров, работ, услуг без учета косвенных налогов] AS FLOAT)AS [Стоимость без НДС]
      ,CAST([Стоимость товаров, работ, услуг с учетом косвенных налогов]AS FLOAT) AS [Стоимость с НДС]
      ,[Код валюты]
      ,ISNULL(CAST(REPLACE([Курс валюты] ,',','.')AS FLOAT),1) [Курс валюты]
      ,CTC_2.NAME AS [Наименование поставщика]
      ,CTC_2.BIN AS [ИИН/БИН поставщика]
      ,CTC_2.katoAddress [Адрес места нахождения поставщика]
      ,FORMAT( CAST([ИИН/БИН.2] AS FLOAT),'000000000000')[ИИН/БИН2]
      ,CTC.name [Наименование покупателя]
      ,CTC.bin [ИИН/БИН покупателя]
      ,CTC.katoAddress [Адрес места нахождения покупателя]
      ,CATO.name [Область покупателя]
      ,CATO2.name [Район покупателя]
      ,CATO3.name [Село покупателя]
      ,[Код страны]
      ,[ИИН/БИН.3] [ИИН/БИН грузополучателя]
      ,[Наименование грузополучателя]
      ,[Адрес доставки]
      ,[Код страны.1]
      ,[Пункт назначения]
      ,CAST([Код товара (ТН ВЭД)] AS FLOAT) AS [Код товара (ТН ВЭД)]  
      ,CAST([Стоимость товаров, работ, услуг без учета косвенных налогов]AS FLOAT)*ISNULL(CAST(REPLACE([Курс валюты] ,',','.')AS FLOAT),1)[Стоимость без НДС в KZT]
      ,CAST([Стоимость товаров, работ, услуг с учетом косвенных налогов]AS FLOAT)*ISNULL(CAST(REPLACE([Курс валюты] ,',','.')AS FLOAT),1) [Стоимость с НДС в KZT]
      ,CAST([Цена (тариф) за единицу ТРУ без косвенных налогов]AS FLOAT)*ISNULL(CAST(REPLACE([Курс валюты] ,',','.')AS FLOAT),1) [Цена за ед, без НДС в KZT]


      --,Convert(DATE, [Дата договора (контракта) на поставку ТРУ], 101) AS [Дата договора (контракта) на поставку ТРУ]

      --,[Код органа государственных доходов]
      --,[Вид счет-фактуры]
      --,[Статус ЭСФ после отправки получателю]
      --,[Дата выписки]
      --,[Дата выписки на бумажном носителе]
      --,[Дата совершения оборота]
      --,[Ф#И#О#, лица выписавшего ЭСФ]
      --,[Номер учетной системы]
      --,[Дата обновления СФ]
      --,[ИИН/БИН]
      --,[Наименование поставщика по данным ИНИС на рус#]
      --,[Наименование поставщика по данным ИС ЭСФ]
      --,[Адрес места нахождения]
      --,[Номер свидетельства плательщика НДС]
      --,[Серия свидетельства плательщика НДС]
      --,[Номер документа, подтверждающего поставку ТРУ]
      --,[Дата документа, подтверждающего поставку ТРУ]
      --,[Дополнительные сведения]
      --,[КБЕ]
      --,[ИИК]
      --,[БИК]
      --,[Наименование банка]
      --,[Доля участия]
      --,[Дата выписки (поставщики)]
      --,[Категория поставщика]
      --,[Наименование получателя по данным ИС ЭСФ]
      --,[Наименование получателя по данным ИНИС на рус#]
      --,[ИИН/БИН1]
      --,[Адрес места нахождения1]
      --,[Дополнительные сведения1]
      --,[Код страны]
      --,[Доля участия1]
      --,[Дата выписки (получатели)]
      --,[Категория получателя]
      --,[ИИН/БИН2]
      --,[Наименование]
      --,[Адрес отправки]
      --,[ИИН/БИН3]
      --,[Наименование грузополучателя]
      --,[Адрес доставки]
      --,[Код страны1]
      --,[Номер договора (контракта) на поставку ТРУ]
      --,Convert(DATETIME, [Дата договора (контракта) на поставку ТРУ], 101)[Дата договора (контракта) на поставку ТРУ]
      --,[Условия оплаты по договору]
      --,[Способ отправления]
      --,[Номер доверенности на поставку ТРУ]
      --,[Дата доверенности на поставку ТРУ]
      --,[Пункт назначения]
      --,[Наличие договора]
      --,[ИИК1]
      --,[Код ТРУ]
      --,[Назначение платежа]
      --,[БИК1]
      --,[Порядковый номер ТРУ]
      --,[Признак происхождения товара, работ, услуг]
      --,AD.[Наименование ТРУ]
      --,[Наименование товаров в соответствии с Декларацией на товары или ]
      --,[Код товара (ТН ВЭД)]
      --,[Единица измерения]
      --,[Кол-во (объем)]
      --,[Цена (тариф) за единицу ТРУ без косвенных налогов]
      --,[Стоимость товаров, работ, услуг без учета косвенных налогов]
      --,[Ставка акциза]
      --,[Сумма акциза]
      --,[Размер оборота по реализации]
      --,[Ставка НДС]
      --,[Сумма НДС]
      --,[Стоимость товаров, работ, услуг с учетом косвенных налогов]
      --,[Номер декларации на товары, заявления в рамках ТС, СТ-1 или СТ-K]
      --,[Номер товарной позиции из заявления о ввозе товаров и уплате кос]
      --,[Дополнительные данные]
      --,[Курс валюты]
      --,[Код валюты]
      --,[Наименование валюты на рус#]
      --,[Всего по счету, стоимость товаров, работ, услуг без учета косвен]
      --,[Всего по счету, размер оборота по реализации]
      --,[Всего по счету, сумма НДС]
      --,[Всего по счету, стоимость товаров, работ, услуг с учетом косвенн]
      --,[ИИН/БИН участника совместной деятельности]
      --,[Номер продукта (товара, услуги)]
      --,[Количество (объём)]
      --,[Сумма НДС1]
      --,[Стоимость ТРУ с учетом НДС]
      --,[Стоимость ТРУ без учета НДС]
      --,[Размер оборота по реализации1]
      --,[Регистрационный номер]
      --,[Дата выписки СФ, к которому выписывается исправленный/дополнител]

	  --INTO LX.DBO.[ALL_CLEARED_V_08.09.2023]
  FROM ALLDATE AS AD
  LEFT JOIN LX.dbo.SPR_PRODUCT AS SP ON AD.[Наименование ТРУ]=SP.[Наименование ТРУ]
  LEFT JOIN LX.dbo.SPR_CATEGORY AS SC ON SP.CATEGORY_ID=SC.ID
  LEFT JOIN LX.[dbo].[CRM_TASK_CLIENT] AS CTC ON AD.[ИИН/БИН.1]=CTC.bin
  LEFT JOIN LX.dbo.CRM_TASK_CLIENT AS CTC_2 ON AD.IIN_BIN_2=CTC_2.bin
  LEFT JOIN L1_X.dbo.cato ON LEFT(CTC_2.katoCode,2)+'0000000'=cato.cato_Id
  LEFT JOIN L1_X.dbo.cato CATO2 ON LEFT(CTC_2.katoCode,4)+'00000'=CATO2.cato_Id
  LEFT JOIN L1_X.dbo.cato CATO3 ON LEFT(CTC_2.katoCode,4)+'000'=CATO3.cato_Id
  LEFT JOIN [L0].[dbo].[upakovki_edinitsy_izmereniya] AS ED ON ED.kod_e_s_f=AD.[Единица измерения] 
    --WHERE [Регистрационный номер ЭСФ (14/02/2023)]='ESF-100140001705-20210601-5215'

  ORDER BY [Регистрационный номер ЭСФ (14/02/2023)]